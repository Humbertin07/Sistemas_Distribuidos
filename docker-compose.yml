services:
  # 1. MIDDLEWARE: Roteadores e Gerenciadores
  ref_server:
    build: ./ref_server
    container_name: ref_server
    ports:
      - "5559:5559" # Porta para os servidores se registrarem

  broker:
    build: ./broker
    container_name: broker
    ports:
      - "5555:5555" # Porta REQ (Clientes -> Broker)
      - "5556:5556" # Porta REP (Broker -> Servidores)
    depends_on:
      - server

  proxy:
    build: ./proxy
    container_name: proxy
    ports:
      - "5557:5557" # Porta XSUB (Servidores -> Proxy)
      - "5558:5558" # Porta XPUB (Proxy -> Clientes)
    depends_on:
      - server

  # 2. WORKERS: Onde a lógica acontece (3 réplicas)
  server:
    build: ./server
    volumes:
      - ./server_data:/data
    depends_on:
      - ref_server
      - broker
      - proxy
    deploy:
      replicas: 3 # Requisito de replicação

  # 3. CLIENTES: Nossos 3 clientes interativos
  client_py:
    build: ./client_py
    container_name: client_py
    depends_on: [broker, proxy]
    stdin_open: true 
    tty: true        
    command: ["python", "-u", "client.py"]

  client_node: 
    build: ./client_node
    container_name: client_node
    depends_on: [broker, proxy]
    stdin_open: true
    tty: true

  client_csharp:
    build: ./client_csharp
    container_name: client_csharp
    depends_on: [broker, proxy]
    stdin_open: true
    tty: true
  
  # 4. BOTS: Clientes automáticos (2 réplicas)
  bot:
    build: ./bot
    depends_on: [broker, proxy]
    deploy:
      replicas: 2